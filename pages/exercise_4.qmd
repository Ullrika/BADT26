---
title: "MCMC sampling software"
subtitle: "Exercise BADT"
author: "Zheng Zhou"
---

## MCMC sampling software

(@) Gibbs sampling and BUGS

- Strength: Simple coding and similar to basic Metropolis algorithm

- Weakness: Really random walks, poor at dealing with complex problems

(@) Hamilton MC and stan

- Strength: Uses gradient information to explore high-dimensional, correlated parameter space more efficiently

- Weakness: Requires more coding efforts

## Stan ecosystem

(@) sampler: rstan, cmdstanr, CmdStanPy, PyMC

(@) high-level utility package: rstanarm, brms, PyStan, bambi and more

## Getting start with Stan

(@) Installation

**If you Use R**: install [cmdstanr](https://mc-stan.org/cmdstanr/)

**If you Use python**: install [cmdstanPy](https://mc-stan.org/cmdstanpy/installation.html)

1. install appropriate C++ toolchain based on your IDE: [for R](https://mc-stan.org/docs/cmdstan-guide/installation.html#cpp-toolchain) and [for python](https://mc-stan.org/cmdstanpy/installation.html#c-toolchain-requirements)

2. install compiler for your IDE

3. install utility package if desire

(@) Once done, run an example model to check the compiler

The beta-binomial example in stan

```{r}
library(cmdstanr)
file <- file.path(cmdstan_path(), "examples", "bernoulli", "bernoulli.stan")
mod <- cmdstan_model(file)
# names correspond to the data block in the Stan program
data_list <- list(N = 10, y = c(0,1,0,0,0,0,0,0,0,1))

# call out the stan script
mod$print()
```

Sampling

```{r}
fit <- mod$sample(
  data = data_list,
  seed = 123,
  chains = 4
)
```


(@) Extract model diagnostics

```{r}
# install.package(c("bayesplot","tidyverse"))
library(bayesplot)
library(tidyverse)
```

Check rhat and effecti sample size:

```{r}
# all parameters
fit$summary()
```

Rhat should be as close to 1 as possible

ESS: ideally number of sampling steps from all chains

Traceplot:

```{r}
# all parameters
mcmc_trace(fit$draws())

# specific parameter
mcmc_trace(fit$draws("theta"))
```

Autocorrelation:

```{r}
# all parameters
mcmc_acf(fit$draws())
```

When something goes wrong, check [this](https://mc-stan.org/docs/reference-manual/analysis.html)

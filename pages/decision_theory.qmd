---
title: "Decision theory"
subtitle: "BADT"
author: "Sahlin"
---

## Generic setup for decison making

- Agents

- Decision alternatives

- Preferences over outcomes

- Impact on outcomes for each decision alternative

- An idea of what is a good decision

Decision rules: 

Bayesian Decision Theory: Maximise expected utility 

There are other decision rules! 

## DT 

- Descriptive: What people actually do, or have done

- Prescriptive: What people should and can do

- Normative: What people should do (in theory, e.g. if rational)

[Medium read on Decision theory at Stanford Encyclopedia of Philosophy Archive](https://plato.stanford.edu/archives/win2020/entries/decision-theory/)

## Preferences 

An agent prefers option $A$ over $B$ means that the agents takes $A$ to be more desirable or choice-worthy than $B$

Indifference $\sim$

Weak preference $\preccurlyeq$

Strong preference $\prec$


Rational preferences of options can be seen to be given by: 

- Completeness 

For any $A, B\in S:\text{ either }A \preccurlyeq B\text{ or } B \preccurlyeq A$

- Transitivity 

For any $A, B, C \in S: \text{ if }A\preccurlyeq B\text{ and } B\preccurlyeq C \text{ then } A \preccurlyeq C$

## Utilities

Utility as a way to measure preferences 

$$\text{For any }A,B \in S: u(A)\leq u(B) \Longleftrightarrow A \preccurlyeq B$$

## Maximise Expected Utility 

Let $p_{ik}$ be the the probability for outcome $O_{ik}$ in lottery $L_i$

von Newmann Morgenstern representation theorem of the expected utility of lottery $L_i$

$$EU(L_i)=\sum_ku(O_{ik})\cdot p_{ik}$$


## Subjective Expected Utility (SEU) 

Savage

Set of outcomes $\mathbf{O}$ - target of desire 

Set of states of the world $\mathbf{S}$ - target of belief

An act can be seen as a function from the states to outcomes. We have at least to acts $f$ and $g$

$f(s_i)$ denotes the outcome of act $f$ when event $s_i \in \mathbf{S}$ is actually happening 

The expected utility of act $f$ is given by *Savage's equation* 

$$U(f)=\sum_i u(f(s_i))\cdot p(s_i)$$

Savage defined six axioms, which when satisfied, generates that a persons belief can be represented by a unique probability function which relates the theory to the theory to maximise expected utility (von Newmann Morgenstern representation theorem)

> To maximise expected utility can be seen as a decision rule for decision problems where the probability of different outcomes are known or when the probability for different outcomes represents a persons belief about that outcome. 

> It is possible to derive a persons belief by asking here to choose between options. This is often done asking them to choose between lotteries with different costs and expected utilities. Betting interpretation of subjective probability. 


## Bayesian decision theory

### Bayesian Belief Network 

Wet grass - Rain- Sprinkler -Umbrella 

I will demonstrate BBN and influence diagram in genie

### Bayesian decision analysis example in stan

[https://mc-stan.org/docs/stan-users-guide/decision-analysis.html](https://mc-stan.org/docs/stan-users-guide/decision-analysis.html)



```{}
# Save this code into a file named "dm.stan"

functions {
  real U(real c, real t) {
    return -(c + 25 * t);
  }
}
data {
  int<lower=0> N;
  array[N] int<lower=1, upper=4> d;
  array[N] real c;
  array[N] real<lower=0> t;
}
parameters {
  vector[4] mu;
  vector<lower=0>[4] sigma;
  array[4] real nu;
  array[4] real<lower=0> tau;
}
model {
  mu ~ normal(0, 1);
  sigma ~ lognormal(0, 0.25);
  nu ~ normal(0, 20);
  tau ~ lognormal(0, 0.25);
  t ~ lognormal(mu[d], sigma[d]);
  c ~ lognormal(nu[d], tau[d]);
}
generated quantities {
  array[4] real util;
  for (k in 1:4) {
    util[k] = U(lognormal_rng(nu[k], tau[k]),
                lognormal_rng(mu[k], sigma[k]));
  }
}
```

```{r}
library(cmdstanr)
library(ggplot2)
library(bayesplot)
```


```{r}
generate_fake_data <- function(N){
d = sample(1:4,N,replace=TRUE)
d_label = c("walk", "bike share", "public transportation", "cab")

mu = sort(rnorm(4,0,0.5),decreasing=TRUE)
sigma = rlnorm(4,0,0.1)
nu = sort(rnorm(4,0,1),decreasing=FALSE)
tau = rlnorm(4,0,0.25)

data.frame(
t = rlnorm(N,mu[d],sigma[d]),
c = rlnorm(N,nu[d],tau[d]),
d = d, d_label = d_label[d])
}
```


```{r}
# prepare data
dat <- generate_fake_data(N = 50)

df <- data.frame(val = c(dat$t,dat$c), d = c(dat$d_label,dat$d_label), variable = rep(c("time","cost"),each=nrow(dat)))
ggplot(df,aes(x=val,y=d,col=d)) +
  geom_boxplot() + 
  geom_jitter(alpha=0.3) +
  facet_wrap(~variable) +
  theme_minimal()
```


```{r}
# turn data to list
stan_data <- list(N = nrow(dat),t=dat$t,c=dat$c,d=dat$d)

# compile model
model.dm <- cmdstan_model(stan_file="dm.stan")

# perform the mcmc sampling
post <- model.dm$sample(data=stan_data)
post$diagnostic_summary()
```


```{r}
# summarise the relevant quantities of interest 
draws <- post$draws()
bayesplot::mcmc_trace(draws,pars = c("util[1]","util[2]","util[3]","util[4]"))
```

```{r}
bayesplot::mcmc_intervals(post$draws(),pars = c("util[1]","util[2]","util[3]","util[4]"), prob=0.8)
```

```{r}
# Calculate the expected utilities 

df_draws <- posterior::as_draws_df(draws)
df_dm <- data.frame(EU = colMeans(df_draws[,c("util[1]","util[2]","util[3]","util[4]")]),
           d = c("walk", "bike share", "public transportation", "cab"))
df_dm$bayesopt <- ""
df_dm$bayesopt[order(df_dm$EU,decreasing=TRUE)[1]] <- "*"
df_dm
```



